MahJong = {}
local Enum = require "Enum"
local Player = require "Player"
local ClickEvent = require "ClickEvent"
local PlayUICT = require "PlayUICT"
local FLibEvent = require "FLibEvent"
--local Network = require "Network"
local protobuf = require "protobuf"
local FairyGUI = require "FairyGUI"
--[[
local AssetManager = require "AssetManager"
	local loader = AssetManager.Load()
	print(loader)
	hoster = AssetManager.Get(196610)
	print(hoster)
	AssetManager.PrintMessage(hoster)
--]]
local newVector3 = CS.UnityEngine.Vector3
local Camera = CS.UnityEngine.Camera
local _mj_asset = {}
local _player_middle_pos
local _player_father = nil--player面前牌
local _chi_pai_father = {}--吃牌父节点
_chi_pai_father.cards = {}
local _pai_bigger = 1--player牌放大倍数
local _chi_pai_smaller = 0.5--吃牌缩小倍数
local _chi_pai_pos_height = 1.7--吃牌高度
local _current_click_pai
local _diceObj--骰子
local _gaiObj--盖子
local _pointFather = {}--牌池父节点
local _modelSize = {length = 0.0171,width = 0.02566,height = 0.036}
local _modelPool = {}--没抓的牌池
local _pai_pool_show = {}--打牌的牌池
local _pai_pool_show_line = 6--打牌每行的牌数
local _operation_pai_show = {}--碰牌的牌池
local _operation_pai_show_position = {
	east = newVector3(-0.31,0,0.31),
	south = newVector3(-0.36,0,-0.28),
	west = newVector3(0.36,0,-0.31),
	north = newVector3(0.36,0,0.25),
}

local _modelPoolLineCount = 34
local _play_pai_count = 14--玩家手牌数目
local _startPosition = {}
local _startRotation = {}
local _myAnimation
local _animationName = {
	stepDown = "GaiDown",
	stepMiddle = "GaiPushMiddle",
	stepUp = "GaiUp",
}
local _animationState = ""
local operationState = Enum.CreateEnumTable({"WAIT", "PENG", "GANG", "CHI", "HU", "DAPAI"},-1)
local currentOperationState = operationState.WAIT
local operationStateTable = {}
-- body
Player.self = self
ClickEvent.MahJong = MahJong
Player.MahJong = MahJong

function awake( ... )
	-- body
	ClickEvent.Awake()
end

function start()

	ClickEvent.Start(ClickEvent.panelTable._play_game_ui)
	ClickEvent.CreateOperationButton()
	MahJong.Init()
	MahJong.AnimationPlay()
	MahJong.ModelPoolInit()
	MahJong.PlayerModelCameraPos()
	MahJong.MjLoader()
	--[[
	
	--]]
	Player.CmdLoadScene("LOAD_SCENE_TYPE_SUCCESS",tonumber(CS.LuaBehaviour._room_id))
end

function MahJong.SetStateTable( paraTable )
	-- body
	operationStateTable = paraTable
end

function MahJong.GetStateTable( ... )
	-- body
	return operationStateTable
end

function MahJong.SetCurrentState(paraState)
	-- body
	currentOperationState = paraState
end

function MahJong.GetCurrentState( ... )
	-- body
	return currentOperationState
end

function MahJong.MjLoader()
	-- body
	local AssetManager = require "AssetManager"
	local resultPath = CS.LuaCommon.resultPath
	local loader = AssetManager.Load(resultPath.."Asset/Asset/")
	local message = AssetManager.GetMessagesByType("ASSET_TYPE_MJ_CARD")
	_mj_asset =  AssetManager.PrintDecodeMessage(message,"Adoter.Asset.MJCard")
	--[[
	AssetManager.PrintMessage(_mj_asset)
	for k, v in pairs(message) do  
    	print(v)
	end
	local data = AssetManager.Get(393238)
	local message = protobuf.decode("Adoter.Asset.CommonLimit", data)
	print(message.type_t)
	for k,v in pairs(data) do
		print(v)
	end
	--]]
end

function MahJong.PlayerModelCameraPos()
	-- body
	_player_middle_pos = Camera.main:ScreenToWorldPoint(newVector3(Camera.main.pixelWidth/2,Camera.main.pixelHeight/100,0.35))
end

function MahJong.Init()
	-- body
	_diceObj = self.transform:Find("Dice").gameObject
	_gaiObj = self.transform:Find("Gai").gameObject
	_pointFather.D = _gaiObj.transform:Find("Point_D/Father").gameObject
	_startPosition.D = newVector3(_modelSize.width/2 - _modelPoolLineCount*_modelSize.width/4,_modelSize.length/2,0)
	_startRotation.D = newVector3.zero
	_pointFather.N = _gaiObj.transform:Find("Point_N/Father").gameObject
	_startPosition.N = newVector3(0,_modelSize.length/2,_modelSize.width/2 - _modelPoolLineCount*_modelSize.width/4)
	_startRotation.N = newVector3(0,-90,0)
	_pointFather.X = _gaiObj.transform:Find("Point_X/Father").gameObject
	_startPosition.X = newVector3(-_modelSize.width/2 + _modelPoolLineCount*_modelSize.width/4,_modelSize.length/2,0)
	_startRotation.X = newVector3(0,-180,0)
	_pointFather.B = _gaiObj.transform:Find("Point_B/Father").gameObject
	_startPosition.B = newVector3(0,_modelSize.length/2,-_modelSize.width/2 + _modelPoolLineCount*_modelSize.width/4)
	_startRotation.B = newVector3(0,-270,0)
	_myAnimation = self:GetComponent("Animation")
	self:GetComponent("AnimationRegister").animationEvent = MahJong.AnimationPlay
	--------------------------------------------------
	--打牌牌池初始化
	_pai_pool_show.point_d = {}
	_pai_pool_show.point_d.paiNumber = 0
	_pai_pool_show.point_d.father = self.transform:Find("PaiPoolShow/Point_D/Father").gameObject
	_pai_pool_show.point_d.startPosition = newVector3(_pai_pool_show_line*_modelSize.width/2 - _modelSize.width/2 ,_modelSize.length/2,0)
	_pai_pool_show.point_d.startRotation = newVector3(180,0,0)
	_pai_pool_show.point_n = {}
	_pai_pool_show.point_n.paiNumber = 0
	_pai_pool_show.point_n.father = self.transform:Find("PaiPoolShow/Point_N/Father").gameObject
	_pai_pool_show.point_n.startPosition = newVector3(0,_modelSize.length/2,_pai_pool_show_line*_modelSize.width/2 - _modelSize.width/2)
	_pai_pool_show.point_n.startRotation = newVector3(180,-90,0)
	_pai_pool_show.point_x = {}
	_pai_pool_show.point_x.paiNumber = 0
	_pai_pool_show.point_x.father = self.transform:Find("PaiPoolShow/Point_X/Father").gameObject
	_pai_pool_show.point_x.startPosition = newVector3(_modelSize.width/2 - _pai_pool_show_line*_modelSize.width/2,_modelSize.length/2,0)
	_pai_pool_show.point_x.startRotation = newVector3(180,-180,0)
	_pai_pool_show.point_b = {}
	_pai_pool_show.point_b.paiNumber = 0
	_pai_pool_show.point_b.father = self.transform:Find("PaiPoolShow/Point_B/Father").gameObject
	_pai_pool_show.point_b.startPosition = newVector3(0,_modelSize.length/2,_modelSize.width/2 - _pai_pool_show_line*_modelSize.width/2)
	_pai_pool_show.point_b.startRotation = newVector3(180,-270,0)
	--碰牌池初始化
	--[[
	--]]
	_operation_pai_show.point_d = {}
	_operation_pai_show.point_d.paiNumber = 0
	_operation_pai_show.point_d.father = self.transform:Find("OperationPoolShow/Point_D/Father").gameObject
	_operation_pai_show.point_d.startPosition = newVector3(_operation_pai_show.point_d.father.transform.parent.position.x ,
		_modelSize.length/2,
		_operation_pai_show.point_d.father.transform.parent.position.z)
	_operation_pai_show.point_d.startRotation = newVector3(180,0,0)
	_operation_pai_show.point_n = {}
	_operation_pai_show.point_n.paiNumber = 0
	_operation_pai_show.point_n.father = self.transform:Find("OperationPoolShow/Point_N/Father").gameObject
	_operation_pai_show.point_n.startPosition = newVector3(_operation_pai_show.point_n.father.transform.parent.position.x ,
		_modelSize.length/2,
		_operation_pai_show.point_n.father.transform.parent.position.z)
	_operation_pai_show.point_n.startRotation = newVector3(180,-90,0)
	_operation_pai_show.point_x = {}
	_operation_pai_show.point_x.paiNumber = 0
	_operation_pai_show.point_x.father = self.transform:Find("OperationPoolShow/Point_X/Father").gameObject
	_operation_pai_show.point_x.startPosition = newVector3(_operation_pai_show.point_x.father.transform.parent.position.x ,
		_modelSize.length/2,
		_operation_pai_show.point_x.father.transform.parent.position.z)
	_operation_pai_show.point_x.startRotation = newVector3(180,-180,0)
	_operation_pai_show.point_b = {}
	_operation_pai_show.point_b.paiNumber = 0
	_operation_pai_show.point_b.father = self.transform:Find("OperationPoolShow/Point_B/Father").gameObject
	_operation_pai_show.point_b.startPosition = newVector3(_operation_pai_show.point_b.father.transform.parent.position.x ,
		_modelSize.length/2,
		_operation_pai_show.point_b.father.transform.parent.position.z)
	_operation_pai_show.point_b.startRotation = newVector3(180,-270,0)
end

function MahJong.ModelPoolInit()
	-- body
	local modelTemp = CS.UnityEngine.Resources.Load("MJModel/null_Model")
	local countTemp = 0
	for i=1,_modelPoolLineCount*4 do
		if i <= _modelPoolLineCount then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.D.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.D
			_modelPool[i].transform.localPosition = 
			_startPosition.D + 
			((i-1)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-1)/2)*newVector3(_modelSize.width,0,0)
		elseif i > _modelPoolLineCount and i <= _modelPoolLineCount*2 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.N.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.N
			_modelPool[i].transform.localPosition = 
			_startPosition.N + 
			((i-_modelPoolLineCount)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount-1)/2)*newVector3(0,0,_modelSize.width)
		elseif i > _modelPoolLineCount*2 and i <= _modelPoolLineCount*3 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.X.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.X
			_modelPool[i].transform.localPosition = 
			_startPosition.X + 
			((i-_modelPoolLineCount*2)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount*2-1)/2)*newVector3(-_modelSize.width,0,0)
		elseif i > _modelPoolLineCount*3 and i <= _modelPoolLineCount*4 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.B.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.B
			_modelPool[i].transform.localPosition = 
			_startPosition.B + 
			((i-_modelPoolLineCount*3)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount*3-1)/2)*newVector3(0,0,-_modelSize.width)
		end

	end
	MahJong.ModelPoolSetActive(false)
	--print(i)
end

function MahJong.ModelPoolSetActive(bool)
	-- body
	for k, v in pairs(_pointFather) do  
    	v:SetActive(bool)
	end
end

function MahJong.UpdateMyDataState()
	-- body
	local myPosition = Player._my_player_data.position
	local _east = self.transform:Find("OperationPoolShow/Point_D").gameObject
	local _south = self.transform:Find("OperationPoolShow/Point_N").gameObject
	local _west = self.transform:Find("OperationPoolShow/Point_X").gameObject
	local _north = self.transform:Find("OperationPoolShow/Point_B").gameObject
	if myPosition == "POSITION_TYPE_SOUTH" then
		self.transform.eulerAngles = newVector3(0,90,0)
		_south.transform.localPosition = _operation_pai_show_position.east
		_west.transform.localPosition = _operation_pai_show_position.south
		_north.transform.localPosition = _operation_pai_show_position.west
		_east.transform.localPosition = _operation_pai_show_position.north
	elseif myPosition == "POSITION_TYPE_WEST" then
		self.transform.eulerAngles = newVector3(0,180,0)
		_west.transform.localPosition = _operation_pai_show_position.east
		_north.transform.localPosition = _operation_pai_show_position.south
		_east.transform.localPosition = _operation_pai_show_position.west
		_south.transform.localPosition = _operation_pai_show_position.north
	elseif myPosition == "POSITION_TYPE_NORTH" then
		self.transform.eulerAngles = newVector3(0,270,0)
		_north.transform.localPosition = _operation_pai_show_position.east
		_east.transform.localPosition = _operation_pai_show_position.south
		_south.transform.localPosition = _operation_pai_show_position.west
		_west.transform.localPosition = _operation_pai_show_position.north
	else
		_east.transform.localPosition = _operation_pai_show_position.east
		_south.transform.localPosition = _operation_pai_show_position.south
		_west.transform.localPosition = _operation_pai_show_position.west
		_north.transform.localPosition = _operation_pai_show_position.north
	end
end

function MahJong.ZhuaPai()
	-- body
	local paiCache = Player._fa_pai_cache
	local tempPaiPool = {}
	for k,v in pairs(_mj_asset) do
		if paiCache.card_type == v.card_type then
			tempPaiPool = v
		end
	end
	MahJong.CreatePlayerModel(""..tempPaiPool.cards[paiCache.card_value].model_path,
		_player_father.currentPaiNumber+1, tempPaiPool.card_type,paiCache.card_value)
	MahJong.SortZhuaPai()
	MahJong.SortPlayerPai()
end

function MahJong.SortZhuaPai( ... )
	-- body
	local hasType = false
	local index = 0
	local tempCard = _player_father.cards[_player_father.currentPaiNumber]
	for k,v in pairs(_player_father.cards) do
		if v.paiType == tempCard.paiType then
			hasType = true
			if v.paiValue >= tempCard.paiValue then
				index = k
				break
			end
		elseif hasType then 
			index = k
			break
		end
	end

	for i = _player_father.currentPaiNumber, index+1, -1 do
		_player_father.cards[i] =  _player_father.cards[i-1]
		_player_father.cards[i].parent.name = ""..i
	end
	_player_father.cards[index] = tempCard
	_player_father.cards[index].parent.name = ""..index
	---[[
	if MahJong._current_click_pai then
		MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height/2,0)
		MahJong._current_click_pai = _player_father.cards[index].child
		MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
	else
		MahJong._current_click_pai = _player_father.cards[index].child
		MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
	end
	--]]
	
end
local _player_father_test = nil
function MahJong.CreatePlayerPaiTest()
	-- body
	if _player_father_test and _player_father_test.father then
		CS.UnityEngine.Object.Destroy(_player_father_test.father)
	end
	_player_father_test = nil
	if not _player_father_test then
		_player_father_test = {}
		_player_father_test.cards = {}
		_player_father_test.father = CS.UnityEngine.GameObject("PlayerFatherTest")
		_player_father_test.father.transform:SetParent(self.transform)
	end
	local paiCount = 0
	for k, v in pairs(Player._invoke_table_test.pais)do
        local tempPaiPool = {}
        for j,n in pairs(_mj_asset) do
        	if n.card_type == v.card_type then
        		tempPaiPool = n
        	end
        end
        for i, m in pairs(v.cards) do
        	paiCount = paiCount + 1
			MahJong.CreatePlayerModelTest(""..tempPaiPool.cards[m].model_path,paiCount,tempPaiPool.card_type,tempPaiPool.cards[m].value)
        end
    end
	MahJong.SortPlayerPaiTest()
end

function MahJong.CreatePlayerModelTest( modelName,paiNumber,paiType,paiValue )
	-- body
	if type(modelName) == "string" then
		local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
		
		_player_father_test.currentPaiNumber = paiNumber
		_player_father_test.cards[paiNumber] = {}
		_player_father_test.cards[paiNumber].parent = CS.UnityEngine.GameObject(""..paiNumber)
		_player_father_test.cards[paiNumber].parent.transform:SetParent(_player_father_test.father.transform)
		_player_father_test.cards[paiNumber].child = CS.UnityEngine.Object.Instantiate(modelTemp,_player_father_test.cards[paiNumber].parent.transform)
		_player_father_test.cards[paiNumber].child.name = modelName
		_player_father_test.cards[paiNumber].child.transform.localEulerAngles = newVector3(-90,0,0)
		_player_father_test.cards[paiNumber].child.transform.localPosition = newVector3(0,_modelSize.height/2,0)
		_player_father_test.cards[paiNumber].parent.transform.localScale = _pai_bigger * newVector3.one
		_player_father_test.cards[paiNumber].parent.transform.localEulerAngles = newVector3(-45,0,0)
		_player_father_test.cards[paiNumber].paiType = paiType
		_player_father_test.cards[paiNumber].paiValue = paiValue
	else
		print("wrongType")
	end
end

function MahJong.CreatePlayerPai()
	-- body
	if not _player_father then
		_player_father = {}
		_player_father.cards = {}
		_player_father.father = CS.UnityEngine.GameObject("PlayerFather")
		_player_father.father.transform:SetParent(self.transform)
	end
	local paiCount = 0
	for k, v in pairs(Player._invoke_table.pais)do
        local tempPaiPool = {}
        for j,n in pairs(_mj_asset) do
        	if n.card_type == v.card_type then
        		tempPaiPool = n
        	end
        end
        for i, m in pairs(v.cards) do
        	paiCount = paiCount + 1
			MahJong.CreatePlayerModel(""..tempPaiPool.cards[m].model_path,paiCount,tempPaiPool.card_type,tempPaiPool.cards[m].value)
        end
    end
	MahJong.SortPlayerPai()
end

function MahJong.CreatePlayerModel(modelName,paiNumber,paiType,paiValue)
	-- body
	if type(modelName) == "string" then
		local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
		
		_player_father.currentPaiNumber = paiNumber
		_player_father.cards[paiNumber] = {}
		_player_father.cards[paiNumber].parent = CS.UnityEngine.GameObject(""..paiNumber)
		_player_father.cards[paiNumber].parent.transform:SetParent(_player_father.father.transform)
		_player_father.cards[paiNumber].child = CS.UnityEngine.Object.Instantiate(modelTemp,_player_father.cards[paiNumber].parent.transform)
		_player_father.cards[paiNumber].child.name = modelName
		_player_father.cards[paiNumber].child:AddComponent(typeof(CS.TouchCT))
		_player_father.cards[paiNumber].child:GetComponent("TouchCT").onClick = MahJong.ClickPaiEvent
		_player_father.cards[paiNumber].child.transform.localEulerAngles = newVector3(-90,0,0)
		_player_father.cards[paiNumber].child.transform.localPosition = newVector3(0,_modelSize.height/2,0)
		_player_father.cards[paiNumber].parent.transform.localScale = _pai_bigger * newVector3.one
		_player_father.cards[paiNumber].parent.transform.localEulerAngles = newVector3(-45,0,0)
		_player_father.cards[paiNumber].paiType = paiType
		_player_father.cards[paiNumber].paiValue = paiValue
	else
		print("wrongType")
	end
end

function MahJong.ClickPaiEvent(gameObject)
	-- body
	if MahJong._current_click_pai then
		if MahJong._current_click_pai == gameObject then
			if currentOperationState ~= operationState.DAPAI then
				return
			end
			print("dapai")
			local paiNumber = tonumber(gameObject.transform.parent.name)
			local paiElement = {
				card_type = _player_father.cards[paiNumber].paiType,
				card_value = _player_father.cards[paiNumber].paiValue,
			}
			MahJong._current_click_pai = nil
			MahJong.DaPai(paiNumber)
			Player.CmdPaiOperation("PAI_OPER_TYPE_DAPAI",{},paiElement)
		else
			MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height/2,0)
			MahJong._current_click_pai = gameObject
			MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
		end
	else	
		MahJong._current_click_pai = gameObject
		MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
	end
end

function MahJong.DaPai(paiNumber)
	-- body
	if paiNumber then
		_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
		CS.UnityEngine.Object.Destroy(_player_father.cards[paiNumber].parent)
		_player_father.cards[paiNumber] = {}
		MahJong.SortPlayerPai(paiNumber)
	end
	currentOperationState = operationState.WAIT
end

function MahJong.DaPaiPoolShow()
	-- body
	local daPaiCacheData = Player.GetDaPaiCache()
	if not daPaiCacheData then
		print("no dapai cache")
		return
	end
	local whichPlayer = daPaiCacheData.position
	local paiType = daPaiCacheData.pai.card_type
	local paiValue = tonumber(daPaiCacheData.pai.card_value)
    local tempPaiPool = {}
    local modelName
    for k, v in pairs(_mj_asset) do
    	if paiType == v.card_type then
    		tempPaiPool = v
    	end
    end
    if tempPaiPool and tempPaiPool.cards and tempPaiPool.cards[paiValue] then
	    modelName = tostring(tempPaiPool.cards[paiValue].model_path)
	else
    	print("no modelName")
		print(paiType)
    	print(paiValue)
    end
    if not modelName then
    	return
    end
    local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
	if whichPlayer == "POSITION_TYPE_EAST" then
		_pai_pool_show.point_d.paiNumber = _pai_pool_show.point_d.paiNumber + 1
		if not _pai_pool_show.point_d.cards then
			_pai_pool_show.point_d.cards = {}
		end
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber] = {}
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber] = CS.UnityEngine.Object.Instantiate(modelTemp,_pai_pool_show.point_d.father.transform)
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber].layer = 0
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber].name = modelName
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber].transform.localEulerAngles = _pai_pool_show.point_d.startRotation
		_pai_pool_show.point_d.cards[_pai_pool_show.point_d.paiNumber].transform.localPosition = _pai_pool_show.point_d.startPosition 
		+ newVector3(-math.fmod(_pai_pool_show.point_d.paiNumber-1,_pai_pool_show_line)*_modelSize.width,
			0,math.modf((_pai_pool_show.point_d.paiNumber-1)/_pai_pool_show_line)*_modelSize.height)
	elseif whichPlayer == "POSITION_TYPE_SOUTH" then
		_pai_pool_show.point_n.paiNumber = _pai_pool_show.point_n.paiNumber + 1
		if not _pai_pool_show.point_n.cards then
			_pai_pool_show.point_n.cards = {}
		end
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber] = {}
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber] = CS.UnityEngine.Object.Instantiate(modelTemp,_pai_pool_show.point_n.father.transform)
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber].layer = 0
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber].name = modelName
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber].transform.localEulerAngles = _pai_pool_show.point_n.startRotation
		_pai_pool_show.point_n.cards[_pai_pool_show.point_n.paiNumber].transform.localPosition = _pai_pool_show.point_n.startPosition 
		+ newVector3(-math.modf((_pai_pool_show.point_n.paiNumber-1)/_pai_pool_show_line)*_modelSize.height,
			0,-math.fmod(_pai_pool_show.point_n.paiNumber-1,_pai_pool_show_line)*_modelSize.width)
	elseif whichPlayer == "POSITION_TYPE_WEST" then
		_pai_pool_show.point_x.paiNumber = _pai_pool_show.point_x.paiNumber + 1
		if not _pai_pool_show.point_x.cards then
			_pai_pool_show.point_x.cards = {}
		end
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber] = {}
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber] = CS.UnityEngine.Object.Instantiate(modelTemp,_pai_pool_show.point_x.father.transform)
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber].layer = 0
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber].name = modelName
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber].transform.localEulerAngles = _pai_pool_show.point_x.startRotation
		_pai_pool_show.point_x.cards[_pai_pool_show.point_x.paiNumber].transform.localPosition = _pai_pool_show.point_x.startPosition 
		+ newVector3(math.fmod(_pai_pool_show.point_x.paiNumber-1,_pai_pool_show_line)*_modelSize.width,
			0,-math.modf((_pai_pool_show.point_x.paiNumber-1)/_pai_pool_show_line)*_modelSize.height)
	elseif whichPlayer == "POSITION_TYPE_NORTH" then
		_pai_pool_show.point_b.paiNumber = _pai_pool_show.point_b.paiNumber + 1
		if not _pai_pool_show.point_b.cards then
			_pai_pool_show.point_b.cards = {}
		end
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber] = {}
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber] = CS.UnityEngine.Object.Instantiate(modelTemp,_pai_pool_show.point_b.father.transform)
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber].layer = 0
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber].name = modelName
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber].transform.localEulerAngles = _pai_pool_show.point_b.startRotation
		_pai_pool_show.point_b.cards[_pai_pool_show.point_b.paiNumber].transform.localPosition = _pai_pool_show.point_b.startPosition 
		+ newVector3(math.modf((_pai_pool_show.point_b.paiNumber-1)/_pai_pool_show_line)*_modelSize.height,
			0,math.fmod(_pai_pool_show.point_b.paiNumber-1,_pai_pool_show_line)*_modelSize.width)
	end

end

function MahJong.PengPai(paiTable)
	-- body
	for i = 1,2 do
		for k,v in pairs(_player_father.cards) do
			if Player._pai_operation_alert_cache.card_type == v.paiType and 
				Player._pai_operation_alert_cache.card_value == v.paiValue then
				_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
				if v.child == MahJong._current_click_pai then
					MahJong._current_click_pai = nil
				end
				CS.UnityEngine.Object.Destroy(v.parent)
				v = {}
				MahJong.SortPlayerPai(k)
				break
			end
		end
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_PENGPAI",{},Player._pai_operation_alert_cache)
	currentOperationState = operationState.DAPAI
end

function MahJong.ClickChiPaiEvent( gameObject )
	-- body
	local paiGroup = tonumber(gameObject.transform.parent.name)
	_chi_pai_father.cards.deleteCards = {}
	local deleteCount = 1
	for k,v in pairs(_chi_pai_father.cards[paiGroup].child) do
		_chi_pai_father.cards.deleteCards[deleteCount] = {}
		_chi_pai_father.cards.deleteCards[deleteCount].card_type = _chi_pai_father.cards[paiGroup].paiType
		_chi_pai_father.cards.deleteCards[deleteCount].paiValue = tonumber(v.name)
		deleteCount = deleteCount + 1
	end
	MahJong.ChiPai()
	CS.UnityEngine.Object.Destroy(_chi_pai_father.father)
	ClickEvent.CloseOperationPanel()
	_chi_pai_father = {}
end

function MahJong.SortChiPai(deleteNumber)
	-- body
	if deleteNumber then
		for i=deleteNumber,_player_father.currentPaiNumber do
			_player_father.cards[i] = _player_father.cards[i+1]
			_player_father.cards[i].parent.name = tostring(i)
		end
		_player_father.cards[_player_father.currentPaiNumber+1] = nil
	end
	for k,v in pairs(_chi_pai_father.cards) do
		v.parent.transform.localPosition = _player_middle_pos 
		+ _chi_pai_smaller*newVector3((_chi_pai_father.currentGroupNumber-1)*_modelSize.width*2 - _modelSize.width*(k-1)*4,
			_modelSize.height/math.sqrt(2) * _chi_pai_pos_height, -_modelSize.height/math.sqrt(2) * _chi_pai_pos_height)
	end
end

function MahJong.CreateChiPai(cardType,paiGroup,paiValue1,paiValue2,paiValue3)--牌类型、牌组数、牌值、
	-- body
    local tempPaiPool = {}
    for k,v in pairs(_mj_asset) do
    	if v.card_type == cardType then
    		tempPaiPool = v
    	end
    end
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue1].model_path,cardType,paiValue1,1)
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue2].model_path,cardType,paiValue2,2)
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue3].model_path,cardType,paiValue3,3)
	MahJong.SortChiPai()
end

function MahJong.CreateChiPaiModel(paiGroup,modelName,paiType,paiValue,sortValue)
	-- body
	if not _chi_pai_father.father then
		
		_chi_pai_father.father = CS.UnityEngine.GameObject("ChiPaiFather")
		_chi_pai_father.father.transform:SetParent(self.transform)
	end
	if type(modelName) == "string" then
		local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
		
		_chi_pai_father.currentGroupNumber = paiGroup
		if not _chi_pai_father.cards[paiGroup] then
			_chi_pai_father.cards[paiGroup] = {}
			_chi_pai_father.cards[paiGroup].child = {}
		end
		if not _chi_pai_father.cards[paiGroup].parent then
			_chi_pai_father.cards[paiGroup].parent = CS.UnityEngine.GameObject(""..paiGroup)
			_chi_pai_father.cards[paiGroup].parent.transform:SetParent(_chi_pai_father.father.transform)
			_chi_pai_father.cards[paiGroup].parent.transform.localEulerAngles = newVector3(-45,0,0)
		end
		_chi_pai_father.cards[paiGroup].child[paiValue] = CS.UnityEngine.Object.Instantiate(modelTemp,_chi_pai_father.cards[paiGroup].parent.transform)
		_chi_pai_father.cards[paiGroup].child[paiValue].name = ""..paiValue
		_chi_pai_father.cards[paiGroup].child[paiValue]:AddComponent(typeof(CS.TouchCT))
		_chi_pai_father.cards[paiGroup].child[paiValue]:GetComponent("TouchCT").onClick = MahJong.ClickChiPaiEvent
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localEulerAngles = newVector3(-90,0,0)
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localPosition = newVector3(0,_modelSize.height/2,0) + 
			_chi_pai_smaller*newVector3(_modelSize.width+(sortValue-1)*_modelSize.width,0,0)
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localScale = _chi_pai_smaller * newVector3.one
		_chi_pai_father.cards[paiGroup].paiType = paiType
		--_chi_pai_father.cards[paiGroup].child[paiValue].paiValue = paiValue
	else
		print("wrongType")
	end
end

function MahJong.ChiPai(paiTable)
	-- body
	--paiTable.card_value --+-1

	print("ChiPai")
	local paiNumber = nil
	local paiElement = {}
	local paiCount = 1
	for k,v in pairs(_chi_pai_father.cards.deleteCards) do
		if v.paiValue ~= Player._pai_operation_alert_cache.card_value then

			paiElement[paiCount] = {}
			paiElement[paiCount].card_type = v.card_type
			paiElement[paiCount].card_value = v.paiValue
			paiCount = paiCount + 1
			
			print(v.card_type)
			print(v.paiValue)
			for m,n in pairs(_player_father.cards) do
				if n.paiType == v.card_type and n.paiValue == v.paiValue then
					paiNumber = m
					print(paiNumber)
					break
				end
			end
			if not paiNumber or paiNumber <= 0 then
				print("no value")
				break
			end
			_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
			--if _player_father.cards[paiNumber] then
			if _player_father.cards[paiNumber].child == MahJong._current_click_pai then
				MahJong._current_click_pai = nil
			end
			CS.UnityEngine.Object.Destroy(_player_father.cards[paiNumber].parent)
			_player_father.cards[paiNumber] = {}
			MahJong.SortPlayerPai(paiNumber)
		end
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_CHIPAI",paiElement,Player._pai_operation_alert_cache)
	currentOperationState = operationState.DAPAI
end

function MahJong.CheckChiPai(paiTable)
	-- body
	local sameTypeCardsTable = {}
	local countSameTypeCards = 0
	local operationPai = Player._pai_operation_alert_cache
	for k,v in pairs(_player_father.cards) do
		if operationPai.card_type == v.paiType then
			countSameTypeCards = countSameTypeCards + 1
			sameTypeCardsTable[countSameTypeCards] = {}
			sameTypeCardsTable[countSameTypeCards] = v
		end
	end
	_chi_pai_father.cards = {}
	if operationPai.card_value == 1 then
		ClickEvent.ShowChiButton()
		_chi_pai_father.cards.deleteCards = {}
		_chi_pai_father.cards.deleteCards[1] = {}
		_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
		_chi_pai_father.cards.deleteCards[2] = {}
		_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value + 1
		_chi_pai_father.cards.deleteCards[3] = {}
		_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 2
	elseif operationPai.card_value == 2 then--1/3,3/4
		if MahJong.CheckPaiValue(sameTypeCardsTable,1)
			and MahJong.CheckPaiValue(sameTypeCardsTable,3)
			and MahJong.CheckPaiValue(sameTypeCardsTable,4) then
			MahJong.CreateChiPai(operationPai.card_type,1,1,2,3)
			MahJong.CreateChiPai(operationPai.card_type,2,2,3,4)
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value + 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,4) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 1
		end
	elseif operationPai.card_value == 8 then--6/7,7/9
		if MahJong.CheckPaiValue(sameTypeCardsTable,6)
			and MahJong.CheckPaiValue(sameTypeCardsTable,7)
			and MahJong.CheckPaiValue(sameTypeCardsTable,9) then
			MahJong.CreateChiPai(operationPai.card_type,1,6,7,8)
			MahJong.CreateChiPai(operationPai.card_type,2,7,8,9)
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,9) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value - 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,6) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 1
		end
	elseif operationPai.card_value == 9 then
		ClickEvent.ShowChiButton()
		_chi_pai_father.cards.deleteCards = {}
		_chi_pai_father.cards.deleteCards[1] = {}
		_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
		_chi_pai_father.cards.deleteCards[2] = {}
		_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
		_chi_pai_father.cards.deleteCards[3] = {}
		_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
		_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value - 2
	else --/-2-1,-1+1,+1+2
		if not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value+1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value - 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value-2) and 
			not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value+2) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 1
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value-1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = operationPai.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = operationPai.card_value + 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = operationPai.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = operationPai.card_value + 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value-2) then
			MahJong.CreateChiPai(operationPai.card_type,1,operationPai.card_value-1,operationPai.card_value,operationPai.card_value+1)
			MahJong.CreateChiPai(operationPai.card_type,2,operationPai.card_value,operationPai.card_value+1,operationPai.card_value+2)
			--MahJong.ChiPai()
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,operationPai.card_value+2) then
			MahJong.CreateChiPai(operationPai.card_type,1,operationPai.card_value-2,operationPai.card_value-1,operationPai.card_value)
			MahJong.CreateChiPai(operationPai.card_type,2,operationPai.card_value-1,operationPai.card_value,operationPai.card_value+1)
			--MahJong.ChiPai()
		else
			MahJong.CreateChiPai(operationPai.card_type,1,operationPai.card_value-2,operationPai.card_value-1,operationPai.card_value)
			MahJong.CreateChiPai(operationPai.card_type,2,operationPai.card_value-1,operationPai.card_value,operationPai.card_value+1)
			MahJong.CreateChiPai(operationPai.card_type,3,operationPai.card_value,operationPai.card_value+1,operationPai.card_value+2)
			--MahJong.ChiPai()
		end
	end
end

function MahJong.CheckPaiValue(paiChiPool,sortValue)
	-- body
	for k,v in pairs(paiChiPool) do
		if v.paiValue == sortValue then
			return true
		end
	end
	return false
end

function MahJong.GuoPai()
	-- body
	if _chi_pai_father.father then
		CS.UnityEngine.Object.Destroy(_chi_pai_father.father)
		_chi_pai_father = {}
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_GIVEUP")
	currentOperationState = operationState.DAPAI
end

function MahJong.GangPai(paiTable)
	-- body
	for i=1,3 do
		for k,v in pairs(_player_father.cards) do
			if Player._pai_operation_alert_cache.card_type == v.paiType and 
				Player._pai_operation_alert_cache.card_value == v.paiValue then
				_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
				if v.child == MahJong._current_click_pai then
					MahJong._current_click_pai = nil
				end
				CS.UnityEngine.Object.Destroy(v.parent)
				v = {}
				MahJong.SortPlayerPai(k)
				break
			end
		end
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_GANGPAI",{},Player._pai_operation_alert_cache)
	currentOperationState = operationState.WAIT
end

function MahJong.HuPai(paiTable)
	-- body
	print("HuPai")
end

function MahJong.SortPlayerPai(deleteNumber)
	-- body
	if deleteNumber then
		for i=deleteNumber,_player_father.currentPaiNumber do
			_player_father.cards[i] = _player_father.cards[i+1]
			_player_father.cards[i].parent.name = tostring(i)
		end
		_player_father.cards[_player_father.currentPaiNumber+1] = nil
	end
	for k,v in pairs(_player_father.cards) do
		v.parent.transform.localPosition = _player_middle_pos +
		_pai_bigger*newVector3((_play_pai_count-1)*_modelSize.width/2 - _modelSize.width*(k-1),0,0)
	end
end

function MahJong.SortPlayerPaiTest()
	-- body
	for k,v in pairs(_player_father_test.cards) do
		v.parent.transform.localPosition = _player_middle_pos +
		_pai_bigger*newVector3((_play_pai_count-1)*_modelSize.width/2 - _modelSize.width*(k-1),
			_modelSize.height * 3,0)
	end
end

function MahJong.OperationPaiShow()
	-- body
	---[[
	local operationPaiShowData = Player.GetPaiOperationShowCache()
	if not operationPaiShowData then
		print("no operationPai cache")
		return
	end
	local whichPlayer = operationPaiShowData.position
	local paiType = operationPaiShowData.pai.card_type
	local paiValue = {}
	if operationPaiShowData.oper_type == "PAI_OPER_TYPE_GANGPAI" then
		for i=1,4 do
    		paiValue[i] = operationPaiShowData.pai.card_value
    	end
    elseif operationPaiShowData.oper_type == "PAI_OPER_TYPE_PENGPAI" then
    	for i=1,3 do
    		paiValue[i] = operationPaiShowData.pai.card_value
    	end
    elseif operationPaiShowData.oper_type == "PAI_OPER_TYPE_CHIPAI" then
		if operationPaiShowData.pais then
			for k,v in pairs(operationPaiShowData.pais) do
				if k > 1 then
					paiValue[k+1] = v.card_value
				else
					paiValue[k] = v.card_value
				end
			end
			paiValue[2] = tonumber(operationPaiShowData.pai.card_value)
		end
    end

    local tempPaiPool = {}
    local modelName = {}
    for k, v in pairs(_mj_asset) do
    	if paiType == v.card_type then
    		tempPaiPool = v
    	end
    end
    if tempPaiPool and tempPaiPool.cards then
    	for k,v in pairs(paiValue) do
		    modelName[k] = tostring(tempPaiPool.cards[v].model_path)
    	end
	else
    	print("no modelName")
		print(paiType)
    end
    if not modelName then
    	return
    end

	if whichPlayer == "POSITION_TYPE_EAST" then
		if not _operation_pai_show.point_d.group then
			_operation_pai_show.point_d.group = {}
		end
	    local modelTemp
		_operation_pai_show.point_d.paiNumber = _operation_pai_show.point_d.paiNumber + 1
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber] = {}
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].father = CS.UnityEngine.GameObject(tostring(_operation_pai_show.point_d.paiNumber))
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].father.transform:SetParent(_operation_pai_show.point_d.father.transform)
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].father.transform.localEulerAngles = newVector3.zero
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards = {}
		for k,v in pairs(modelName) do
			modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..v)
			_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k] = CS.UnityEngine.Object.Instantiate(modelTemp,_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].father.transform)
			_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].layer = 0
			_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].name = v
			if k == 2 then
				_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_d.startRotation + newVector3(0,-90,0)
			else
				_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_d.startRotation
			end
			_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].transform.localPosition = newVector3((k-2)*(_modelSize.width+_modelSize.height)/2,_modelSize.length/2,0)
			if k == 4 then
				_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k].transform.localPosition = _operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].cards[k-1].transform.localPosition + 
				newVector3(_modelSize.width,0,0)
			end
		end
		_operation_pai_show.point_d.group[_operation_pai_show.point_d.paiNumber].father.transform.localPosition = newVector3((_operation_pai_show.point_d.paiNumber-1)*(_modelSize.height+_modelSize.width*2+_modelSize.length),0,0)
	elseif whichPlayer == "POSITION_TYPE_SOUTH" then
		if not _operation_pai_show.point_n.group then
			_operation_pai_show.point_n.group = {}
		end
	    local modelTemp
		_operation_pai_show.point_n.paiNumber = _operation_pai_show.point_n.paiNumber + 1
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber] = {}
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].father = CS.UnityEngine.GameObject(tostring(_operation_pai_show.point_n.paiNumber))
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].father.transform:SetParent(_operation_pai_show.point_n.father.transform)
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].father.transform.localEulerAngles = newVector3.zero
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards = {}
		for k,v in pairs(modelName) do
			modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..v)
			_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k] = CS.UnityEngine.Object.Instantiate(modelTemp,_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].father.transform)
			_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].layer = 0
			_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].name = v
			if k == 2 then
				_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_n.startRotation + newVector3(0,-90,0)
			else
				_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_n.startRotation
			end
			_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].transform.localPosition = newVector3(0,_modelSize.length/2,(k-2)*(_modelSize.width+_modelSize.height)/2)
			if k == 4 then
				_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k].transform.localPosition = _operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].cards[k-1].transform.localPosition + 
				newVector3(0,0,_modelSize.width)
			end
		end
		_operation_pai_show.point_n.group[_operation_pai_show.point_n.paiNumber].father.transform.localPosition = newVector3(0,0,(_operation_pai_show.point_n.paiNumber-1)*(_modelSize.height+_modelSize.width*2+_modelSize.length))
	elseif whichPlayer == "POSITION_TYPE_WEST" then
		if not _operation_pai_show.point_x.group then
			_operation_pai_show.point_x.group = {}
		end
	    local modelTemp
		_operation_pai_show.point_x.paiNumber = _operation_pai_show.point_x.paiNumber + 1
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber] = {}
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].father = CS.UnityEngine.GameObject(tostring(_operation_pai_show.point_x.paiNumber))
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].father.transform:SetParent(_operation_pai_show.point_x.father.transform)
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].father.transform.localEulerAngles = newVector3.zero
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards = {}
		for k,v in pairs(modelName) do
			modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..v)
			_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k] = CS.UnityEngine.Object.Instantiate(modelTemp,_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].father.transform)
			_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].layer = 0
			_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].name = v
			if k == 2 then
				_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_x.startRotation + newVector3(0,-90,0)
			else
				_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_x.startRotation
			end
			_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].transform.localPosition = newVector3(-(k-2)*(_modelSize.width+_modelSize.height)/2,_modelSize.length/2,0)
			if k == 4 then
				_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k].transform.localPosition = _operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].cards[k-1].transform.localPosition + 
				newVector3(-_modelSize.width,0,0)
			end
		end
		_operation_pai_show.point_x.group[_operation_pai_show.point_x.paiNumber].father.transform.localPosition = newVector3(-(_operation_pai_show.point_x.paiNumber-1)*(_modelSize.height+_modelSize.width*2+_modelSize.length),0,0)
	elseif whichPlayer == "POSITION_TYPE_NORTH" then
		if not _operation_pai_show.point_b.group then
			_operation_pai_show.point_b.group = {}
		end
	    local modelTemp
		_operation_pai_show.point_b.paiNumber = _operation_pai_show.point_b.paiNumber + 1
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber] = {}
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].father = CS.UnityEngine.GameObject(tostring(_operation_pai_show.point_b.paiNumber))
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].father.transform:SetParent(_operation_pai_show.point_b.father.transform)
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].father.transform.localEulerAngles = newVector3.zero
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards = {}
		for k,v in pairs(modelName) do
			modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..v)
			_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k] = CS.UnityEngine.Object.Instantiate(modelTemp,_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].father.transform)
			_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].layer = 0
			_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].name = v
			if k == 2 then
				_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_b.startRotation + newVector3(0,-90,0)
			else
				_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].transform.localEulerAngles = _operation_pai_show.point_b.startRotation
			end
			_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].transform.localPosition = newVector3(0,_modelSize.length/2,-(k-2)*(_modelSize.width+_modelSize.height)/2)
			if k == 4 then
				_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k].transform.localPosition = _operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].cards[k-1].transform.localPosition + 
				newVector3(0,0,-_modelSize.width)
			end
		end
		_operation_pai_show.point_b.group[_operation_pai_show.point_b.paiNumber].father.transform.localPosition = newVector3(0,0,-(_operation_pai_show.point_b.paiNumber-1)*(_modelSize.height+_modelSize.width*2+_modelSize.length))
	end
	--]]

end

function MahJong.AnimationPlay()
	-- body
	switch = {
		[_animationName.stepDown] = function( ... )
			-- body
			MahJong.ModelPoolSetActive(true)
			_myAnimation:Play(_animationName.stepMiddle)
			_animationState = _animationName.stepMiddle
		end,
		[_animationName.stepMiddle] = function( ... )
			-- body
			_myAnimation:Play(_animationName.stepUp)
			_animationState = _animationName.stepUp
		end,
		[_animationName.stepUp] = function( ... )
			-- body
			_animationState = ""
			print("startGame")
		end,
	}
	local fSwitch = switch[_animationState]

	if fSwitch then
		local result = fSwitch()
	else
		_myAnimation:Play("GaiDown")
		_animationState = _animationName.stepDown
		--print("key no found")
	end
end

--local _rotate_speed = 2000
function update()
	-- body
	--local speed = CS.UnityEngine.Vector3.up * CS.UnityEngine.Time.deltaTime * _rotate_speed
	--_dice_obj.transform:Rotate(speed)
	if Player.self == self then
		local x = Player.GetinvokeFunctionCache()
		if x then
			x()
		end
	end
end
return MahJong