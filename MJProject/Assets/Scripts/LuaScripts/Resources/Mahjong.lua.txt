local Enum = require "Enum"
local Player = require "Player"
local ClickEvent = require "ClickEvent"
local PlayUICT = require "PlayUICT"
local FLibEvent = require "FLibEvent"
local Network = require "Network"
local protobuf = require "protobuf"
--[[
local AssetManager = require "AssetManager"
	local loader = AssetManager.Load()
	print(loader)
	hoster = AssetManager.Get(196610)
	print(hoster)
	AssetManager.PrintMessage(hoster)
--]]
MahJong = {}
local newVector3 = CS.UnityEngine.Vector3
local Camera = CS.UnityEngine.Camera
local _mj_asset = {}
local _player_middle_pos
local _player_father = nil--player面前牌
local _chi_pai_father = {}--吃牌父节点
_chi_pai_father.cards = {}
local _pai_bigger = 1--player牌放大倍数
local _chi_pai_smaller = 0.5--吃牌缩小倍数
local _chi_pai_pos_height = 1.3--吃牌高度
local _current_click_pai
local _diceObj
local _gaiObj
local _pointFather = {}--牌池父节点
local _modelSize = {length = 0.0171,width = 0.02566,height = 0.036}
local _modelPool = {}
local _modelPoolLineCount = 36
local _startPosition = {}
local _startRotation = {}
local _myAnimation
local _animationName = {
	stepDown = "GaiDown",
	stepMiddle = "GaiPushMiddle",
	stepUp = "GaiUp",
}
local _animationState = ""
local operationState = Enum.CreateEnumTable({"WAIT", "PENG", "GANG", "CHI", "HU", "DAPAI"},-1)
local currentOperationState = operationState.WAIT
local operationStateTable = {}
Player.self = self
ClickEvent.MahJong = MahJong
Player.MahJong = MahJong
	
function start()
	-- body
	PlayUICT.Init()
	MahJong.Init()
	MahJong.AnimationPlay()
	MahJong.ModelPoolInit()
	MahJong.PlayerModelCameraPos()
	MahJong.MjLoader()
	--[[
	MahJong.CreateChiPai("CARD_TYPE_WANZI",1,1,2,3)
	MahJong.CreateChiPai("CARD_TYPE_WANZI",2,2,3,4)
	--]]
	Player.CmdLoadScene("LOAD_SCENE_TYPE_SUCCESS",tonumber(CS.LuaBehaviour._room_id))
end

function MahJong.SetStateTable( paraTable )
	-- body
	operationStateTable = paraTable
end

function MahJong.GetStateTable( ... )
	-- body
	return operationStateTable
end

function MahJong.SetCurrentState(paraState)
	-- body
	currentOperationState = paraState
end

function MahJong.GetCurrentState( ... )
	-- body
	return currentOperationState
end

function MahJong.MjLoader()
	-- body
	local AssetManager = require "AssetManager"
	local resultPath = CS.LuaCommon.resultPath
	local loader = AssetManager.Load(resultPath.."Asset/Asset/")
	local message = AssetManager.GetMessagesByType("ASSET_TYPE_MJ_CARD")
	_mj_asset =  AssetManager.PrintDecodeMessage(message,"Adoter.Asset.MJCard")
	--[[
	AssetManager.PrintMessage(_mj_asset)
	for k, v in pairs(message) do  
    	print(v)
	end
	local data = AssetManager.Get(393238)
	local message = protobuf.decode("Adoter.Asset.CommonLimit", data)
	print(message.type_t)
	for k,v in pairs(data) do
		print(v)
	end
	--]]
end

function MahJong.PlayerModelCameraPos()
	-- body
	_player_middle_pos = Camera.main:ScreenToWorldPoint(newVector3(Camera.main.pixelWidth/2,Camera.main.pixelHeight/100,0.35))
end

function MahJong.Init()
	-- body
	_diceObj = self.transform:Find("Dice").gameObject
	_gaiObj = self.transform:Find("Gai").gameObject
	_pointFather.D = _gaiObj.transform:Find("Point_D/Father").gameObject
	_startPosition.D = newVector3(_modelSize.width/2 - _modelPoolLineCount*_modelSize.width/4,_modelSize.length/2,0)
	_startRotation.D = newVector3.zero
	_pointFather.N = _gaiObj.transform:Find("Point_N/Father").gameObject
	_startPosition.N = newVector3(0,_modelSize.length/2,_modelSize.width/2 - _modelPoolLineCount*_modelSize.width/4)
	_startRotation.N = newVector3(0,-90,0)
	_pointFather.X = _gaiObj.transform:Find("Point_X/Father").gameObject
	_startPosition.X = newVector3(-_modelSize.width/2 + _modelPoolLineCount*_modelSize.width/4,_modelSize.length/2,0)
	_startRotation.X = newVector3(0,-180,0)
	_pointFather.B = _gaiObj.transform:Find("Point_B/Father").gameObject
	_startPosition.B = newVector3(0,_modelSize.length/2,-_modelSize.width/2 + _modelPoolLineCount*_modelSize.width/4)
	_startRotation.B = newVector3(0,-270,0)
	_myAnimation = self:GetComponent("Animation")
	self:GetComponent("AnimationRegister").animationEvent = MahJong.AnimationPlay
end

function MahJong.ModelPoolInit()
	-- body
	local modelTemp = CS.UnityEngine.Resources.Load("MJModel/null_Model")
	local countTemp = 0
	for i=1,_modelPoolLineCount*4 do
		if i <= _modelPoolLineCount then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.D.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.D
			_modelPool[i].transform.localPosition = 
			_startPosition.D + 
			((i-1)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-1)/2)*newVector3(_modelSize.width,0,0)
		elseif i > _modelPoolLineCount and i <= _modelPoolLineCount*2 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.N.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.N
			_modelPool[i].transform.localPosition = 
			_startPosition.N + 
			((i-_modelPoolLineCount)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount-1)/2)*newVector3(0,0,_modelSize.width)
		elseif i > _modelPoolLineCount*2 and i <= _modelPoolLineCount*3 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.X.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.X
			_modelPool[i].transform.localPosition = 
			_startPosition.X + 
			((i-_modelPoolLineCount*2)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount*2-1)/2)*newVector3(-_modelSize.width,0,0)
		elseif i > _modelPoolLineCount*3 and i <= _modelPoolLineCount*4 then
			_modelPool[i] = CS.UnityEngine.Object.Instantiate(modelTemp,_pointFather.B.transform)
			_modelPool[i].transform.localEulerAngles = _startRotation.B
			_modelPool[i].transform.localPosition = 
			_startPosition.B + 
			((i-_modelPoolLineCount*3)%2)*newVector3(0,_modelSize.length,0) + 
			math.modf((i-_modelPoolLineCount*3-1)/2)*newVector3(0,0,-_modelSize.width)
		end

	end
	MahJong.ModelPoolSetActive(false)
	--print(i)
end

function MahJong.ModelPoolSetActive(bool)
	-- body
	for k, v in pairs(_pointFather) do  
    	v:SetActive(bool)
	end
end

function MahJong.ZhuaPai()
	-- body
	local tempPaiPool = {}
	for k,v in pairs(_mj_asset) do
		if Player._pai_operation_alert_cache.card_type == v.card_type then
			tempPaiPool = v
		end
	end
	MahJong.CreatePlayerModel(""..tempPaiPool.cards[Player._pai_operation_alert_cache.card_value].model_path,
		_player_father.currentPaiNumber+1, tempPaiPool.card_type,Player._pai_operation_alert_cache.card_value)
	--[[
	local temp = _player_father.cards[x]
	_player_father.cards[x] = _player_father.cards[y]
	_player_father.cards[y] = temp
	_player_father.cards[x].parent.name = "".. x
	]]
	MahJong.SortPlayerPai()
end

function MahJong.CreatePlayerPai()
	-- body
	local paiCount = 0
	for k, v in pairs(Player._invoke_table.pais)do
        local tempPaiPool = {}
        for j,n in pairs(_mj_asset) do
        	if n.card_type == v.card_type then
        		tempPaiPool = n
        	end
        end
        for i, m in pairs(v.cards) do
        	paiCount = paiCount + 1
			MahJong.CreatePlayerModel(""..tempPaiPool.cards[m].model_path,paiCount,tempPaiPool.card_type,tempPaiPool.cards[m].value)
        end
    end
	MahJong.SortPlayerPai()
end

function MahJong.CreatePlayerModel(modelName,paiNumber,paiType,paiValue)
	-- body
	if not _player_father then
		_player_father = {}
		_player_father.cards = {}
		_player_father.father = CS.UnityEngine.GameObject("PlayerFather")
		_player_father.father.transform:SetParent(self.transform)
	end
	if type(modelName) == "string" then
		local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
		
		_player_father.currentPaiNumber = paiNumber
		_player_father.cards[paiNumber] = {}
		_player_father.cards[paiNumber].parent = CS.UnityEngine.GameObject(""..paiNumber)
		_player_father.cards[paiNumber].parent.transform:SetParent(_player_father.father.transform)
		_player_father.cards[paiNumber].child = CS.UnityEngine.Object.Instantiate(modelTemp,_player_father.cards[paiNumber].parent.transform)
		_player_father.cards[paiNumber].child.name = modelName
		_player_father.cards[paiNumber].child:AddComponent(typeof(CS.TouchCT))
		_player_father.cards[paiNumber].child:GetComponent("TouchCT").onClick = MahJong.ClickPaiEvent
		_player_father.cards[paiNumber].child.transform.localEulerAngles = newVector3(-90,0,0)
		_player_father.cards[paiNumber].child.transform.localPosition = newVector3(0,_modelSize.height/2,0)
		_player_father.cards[paiNumber].parent.transform.localScale = _pai_bigger * newVector3.one
		_player_father.cards[paiNumber].parent.transform.localEulerAngles = newVector3(-45,0,0)
		_player_father.cards[paiNumber].paiType = paiType
		_player_father.cards[paiNumber].paiValue = paiValue
	else
		print("wrongType")
	end
end

function MahJong.ClickPaiEvent(gameObject)
	-- body
	if MahJong._current_click_pai then
		if MahJong._current_click_pai == gameObject then
			if currentOperationState ~= operationState.DAPAI then
				return
			end
			print("dapai")
			local paiNumber = tonumber(gameObject.transform.parent.name)
			local paiElement = {
				card_type = _player_father.cards[paiNumber].paiType,
				card_value = _player_father.cards[paiNumber].paiValue,
			}
			Player.CmdPaiOperation("PAI_OPER_TYPE_DAPAI",{},paiElement)
			MahJong._current_click_pai = nil
			MahJong.DaPai(paiNumber)
		else
			MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height/2,0)
			MahJong._current_click_pai = gameObject
			MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
		end
	else	
		MahJong._current_click_pai = gameObject
		MahJong._current_click_pai.transform.localPosition = newVector3(0,_modelSize.height,0)
	end
end

function MahJong.DaPai(paiNumber)
	-- body
	if paiNumber then
		_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
		CS.UnityEngine.Object.Destroy(_player_father.cards[paiNumber].parent)
		_player_father.cards[paiNumber] = {}
		MahJong.SortPlayerPai(paiNumber)
	end
	currentOperationState = operationState.WAIT
end

function MahJong.PengPai(paiTable)
	-- body
	local deleteCardsCount = 0
	for k,v in pairs(_player_father.cards) do
		if Player._pai_operation_alert_cache.card_type == v.paiType and 
			Player._pai_operation_alert_cache.card_value == v.paiValue and deleteCardsCount < 2 then
			deleteCardsCount = deleteCardsCount + 1
			_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
			CS.UnityEngine.Object.Destroy(v.parent)
			v = {}
			MahJong.SortPlayerPai(k)
		end
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_PENGPAI")
	currentOperationState = operationState.DAPAI
end

function MahJong.ClickChiPaiEvent( gameObject )
	-- body
	local paiGroup = tonumber(gameObject.transform.parent.name)
	_chi_pai_father.cards.deleteCards = {}
	local deleteCount = 1

	for k,v in pairs(_chi_pai_father.cards[paiGroup].child) do
		_chi_pai_father.cards.deleteCards[deleteCount].card_type = _chi_pai_father.cards[paiGroup].paiType
		_chi_pai_father.cards.deleteCards[deleteCount].paiValue = tonumber(v.name)
		deleteCount = deleteCount + 1
	end
	MahJong.ChiPai()
	CS.UnityEngine.Object.Destroy(_chi_pai_father.father)
	_chi_pai_father.father = {}
end

function MahJong.SortChiPai(deleteNumber)
	-- body
	if deleteNumber then
		for i=deleteNumber,_player_father.currentPaiNumber do
			_player_father.cards[i] = _player_father.cards[i+1]
			_player_father.cards[i].parent.name = tostring(i)
		end
		_player_father.cards[_player_father.currentPaiNumber+1] = nil
	end
	for k,v in pairs(_chi_pai_father.cards) do
		v.parent.transform.localPosition = _player_middle_pos 
		+ _chi_pai_smaller*newVector3((_chi_pai_father.currentGroupNumber-1)*_modelSize.width*2 - _modelSize.width*(k-1)*4,
			_modelSize.height/math.sqrt(2) * _chi_pai_pos_height, -_modelSize.height/math.sqrt(2) * _chi_pai_pos_height)
	end
end

function MahJong.CreateChiPai(cardType,paiGroup,paiValue1,paiValue2,paiValue3)--牌类型、牌组数、牌值、
	-- body
    local tempPaiPool = {}
    for k,v in pairs(_mj_asset) do
    	if v.card_type == cardType then
    		tempPaiPool = v
    	end
    end
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue1].model_path,paiValue1,1)
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue2].model_path,paiValue2,2)
	MahJong.CreateChiPaiModel(paiGroup,""..tempPaiPool.cards[paiValue3].model_path,paiValue3,3)
	MahJong.SortChiPai()
end

function MahJong.CreateChiPaiModel(paiGroup,modelName,paiValue,sortValue)
	-- body
	if not _chi_pai_father.father then
		
		_chi_pai_father.father = CS.UnityEngine.GameObject("ChiPaiFather")
		_chi_pai_father.father.transform:SetParent(self.transform)
	end
	if type(modelName) == "string" then
		local modelTemp = CS.UnityEngine.Resources.Load("MJModel/"..modelName)
		
		_chi_pai_father.currentGroupNumber = paiGroup
		if not _chi_pai_father.cards[paiGroup] then
			_chi_pai_father.cards[paiGroup] = {}
			_chi_pai_father.cards[paiGroup].child = {}
		end
		if not _chi_pai_father.cards[paiGroup].parent then
			_chi_pai_father.cards[paiGroup].parent = CS.UnityEngine.GameObject(""..paiGroup)
			_chi_pai_father.cards[paiGroup].parent.transform:SetParent(_chi_pai_father.father.transform)
			_chi_pai_father.cards[paiGroup].parent.transform.localEulerAngles = newVector3(-45,0,0)
		end
		_chi_pai_father.cards[paiGroup].child[paiValue] = CS.UnityEngine.Object.Instantiate(modelTemp,_chi_pai_father.cards[paiGroup].parent.transform)
		_chi_pai_father.cards[paiGroup].child[paiValue].name = ""..paiValue
		_chi_pai_father.cards[paiGroup].child[paiValue]:AddComponent(typeof(CS.TouchCT))
		_chi_pai_father.cards[paiGroup].child[paiValue]:GetComponent("TouchCT").onClick = MahJong.ClickChiPaiEvent
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localEulerAngles = newVector3(-90,0,0)
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localPosition = newVector3(0,_modelSize.height/2,0) + 
			_chi_pai_smaller*newVector3(_modelSize.width+(sortValue-1)*_modelSize.width,0,0)
		_chi_pai_father.cards[paiGroup].child[paiValue].transform.localScale = _chi_pai_smaller * newVector3.one
		_chi_pai_father.cards[paiGroup].paiType = paiType
		--_chi_pai_father.cards[paiGroup].child[paiValue].paiValue = paiValue
	else
		print("wrongType")
	end
end

function MahJong.ChiPai(paiTable)
	-- body
	--paiTable.card_value --+-1

	print("ChiPai")
	local paiNumber
	local paiElement = {}
	for k,v in pairs(_chi_pai_father.cards.deleteCards) do
		paiElement[k] = {}
		paiElement[k].card_type = v.card_type
		paiElement[k].card_value = v.paiValue
		if v.paiValue ~= Player._pai_operation_alert_cache.card_value then
			for m,n in pairs(_player_father.cards) do
				if n.paiType == v.card_type and n.paiValue == v.paiValue then
					paiNumber = m
				end
			end
			_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
			CS.UnityEngine.Object.Destroy(_player_father.cards[paiNumber].parent)
			_player_father.cards[paiNumber] = {}
			MahJong.SortPlayerPai(paiNumber)
		end
	end
	_chi_pai_father = {}
	Player.CmdPaiOperation("PAI_OPER_TYPE_CHIPAI",paiElement,{})
	currentOperationState = operationState.DAPAI
end

function MahJong.CheckChiPai(paiTable)
	-- body
	local sameTypeCardsTable = {}
	local countSameTypeCards = 0
	for k,v in pairs(_player_father.cards) do
		if Player._pai_operation_alert_cache.card_type == v.paiType then
			countSameTypeCards = countSameTypeCards + 1
			sameTypeCardsTable[countSameTypeCards] = {}
			sameTypeCardsTable[countSameTypeCards] = v
		end
	end
	
	if Player._pai_operation_alert_cache.card_value == 1 then
		ClickEvent.ShowChiButton()
		_chi_pai_father.cards.deleteCards = {}
		_chi_pai_father.cards.deleteCards[1] = {}
		_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
		_chi_pai_father.cards.deleteCards[2] = {}
		_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value + 1
		_chi_pai_father.cards.deleteCards[3] = {}
		_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 2
	elseif Player._pai_operation_alert_cache.card_value == 2 then--1/3,3/4
		if MahJong.CheckPaiValue(sameTypeCardsTable,1)
			and MahJong.CheckPaiValue(sameTypeCardsTable,3)
			and MahJong.CheckPaiValue(sameTypeCardsTable,4) then
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,1,1,2,3)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,2,2,3,4)
			MahJong.ChiPai()
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value + 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,4) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 1
		end
	elseif Player._pai_operation_alert_cache.card_value == 8 then--6/7,7/9
		if MahJong.CheckPaiValue(sameTypeCardsTable,6)
			and MahJong.CheckPaiValue(sameTypeCardsTable,7)
			and MahJong.CheckPaiValue(sameTypeCardsTable,9) then
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,1,6,7,8)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,2,7,8,9)
			MahJong.ChiPai()
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,9) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value - 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,6) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 1
		end
	elseif Player._pai_operation_alert_cache.card_value == 9 then
		ClickEvent.ShowChiButton()
		_chi_pai_father.cards.deleteCards = {}
		_chi_pai_father.cards.deleteCards[1] = {}
		_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
		_chi_pai_father.cards.deleteCards[2] = {}
		_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
		_chi_pai_father.cards.deleteCards[3] = {}
		_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
		_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value - 2
	else --/-2-1,-1+1,+1+2
		if not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value+1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value - 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value-2) and 
			not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value+2) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value - 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 1
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value-1) then
			ClickEvent.ShowChiButton()
			_chi_pai_father.cards.deleteCards = {}
			_chi_pai_father.cards.deleteCards[1] = {}
			_chi_pai_father.cards.deleteCards[1].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[1].paiValue = Player._pai_operation_alert_cache.card_value
			_chi_pai_father.cards.deleteCards[2] = {}
			_chi_pai_father.cards.deleteCards[2].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[2].paiValue = Player._pai_operation_alert_cache.card_value + 1
			_chi_pai_father.cards.deleteCards[3] = {}
			_chi_pai_father.cards.deleteCards[3].card_type = Player._pai_operation_alert_cache.card_type
			_chi_pai_father.cards.deleteCards[3].paiValue = Player._pai_operation_alert_cache.card_value + 2
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value-2) then
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,1,Player._pai_operation_alert_cache.card_value-1,Player._pai_operation_alert_cache.card_value,Player._pai_operation_alert_cache.card_value+1)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,2,Player._pai_operation_alert_cache.card_value,Player._pai_operation_alert_cache.card_value+1,Player._pai_operation_alert_cache.card_value+2)
			--MahJong.ChiPai()
		elseif not MahJong.CheckPaiValue(sameTypeCardsTable,Player._pai_operation_alert_cache.card_value+2) then
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,1,Player._pai_operation_alert_cache.card_value-2,Player._pai_operation_alert_cache.card_value-1,Player._pai_operation_alert_cache.card_value)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,2,Player._pai_operation_alert_cache.card_value-1,Player._pai_operation_alert_cache.card_value,Player._pai_operation_alert_cache.card_value+1)
			--MahJong.ChiPai()
		else
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,1,Player._pai_operation_alert_cache.card_value-2,Player._pai_operation_alert_cache.card_value-1,Player._pai_operation_alert_cache.card_value)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,2,Player._pai_operation_alert_cache.card_value-1,Player._pai_operation_alert_cache.card_value,Player._pai_operation_alert_cache.card_value+1)
			MahJong.CreateChiPai(Player._pai_operation_alert_cache.card_type,3,Player._pai_operation_alert_cache.card_value,Player._pai_operation_alert_cache.card_value+1,Player._pai_operation_alert_cache.card_value+2)
			--MahJong.ChiPai()
		end
	end
end

function MahJong.CheckPaiValue(paiChiPool,sortValue)
	-- body
	for k,v in pairs(paiChiPool) do
		if v.paiValue == sortValue then
			return true
		end
	end
	return false
end

function MahJong.GuoPai()
	-- body
	Player.CmdPaiOperation("PAI_OPER_TYPE_GIVEUP")
	currentOperationState = operationState.DAPAI
end

function MahJong.GangPai(paiTable)
	-- body
	for k,v in pairs(_player_father.cards) do
		if Player._pai_operation_alert_cache.card_type == v.card_type and Player._pai_operation_alert_cache.card_value == v.card_value then
			_player_father.currentPaiNumber = _player_father.currentPaiNumber-1
			CS.UnityEngine.Object.Destroy(v.parent)
			v = {}
			MahJong.SortPlayerPai(k)
		end
	end
	Player.CmdPaiOperation("PAI_OPER_TYPE_GANGPAI")
	currentOperationState = operationState.WAIT
end

function MahJong.HuPai(paiTable)
	-- body
	print("HuPai")
end

function MahJong.SortPlayerPai(deleteNumber)
	-- body
	if deleteNumber then
		for i=deleteNumber,_player_father.currentPaiNumber do
			_player_father.cards[i] = _player_father.cards[i+1]
			_player_father.cards[i].parent.name = tostring(i)
		end
		_player_father.cards[_player_father.currentPaiNumber+1] = nil
	end
	for k,v in pairs(_player_father.cards) do
		v.parent.transform.localPosition = _player_middle_pos +
		_pai_bigger*newVector3((_player_father.currentPaiNumber-1)*_modelSize.width/2 - _modelSize.width*(k-1),0,0)
	end
end

function MahJong.AnimationPlay()
	-- body
	switch = {
		[_animationName.stepDown] = function( ... )
			-- body
			MahJong.ModelPoolSetActive(true)
			_myAnimation:Play(_animationName.stepMiddle)
			_animationState = _animationName.stepMiddle
		end,
		[_animationName.stepMiddle] = function( ... )
			-- body
			_myAnimation:Play(_animationName.stepUp)
			_animationState = _animationName.stepUp
		end,
		[_animationName.stepUp] = function( ... )
			-- body
			_animationState = ""
			print("startGame")
		end,
	}
	local fSwitch = switch[_animationState]

	if fSwitch then
		local result = fSwitch()
	else
		_myAnimation:Play("GaiDown")
		_animationState = _animationName.stepDown
		--print("key no found")
	end
end

--local _rotate_speed = 2000
function update()
	-- body
	--local speed = CS.UnityEngine.Vector3.up * CS.UnityEngine.Time.deltaTime * _rotate_speed
	--_dice_obj.transform:Rotate(speed)
end
return MahJong